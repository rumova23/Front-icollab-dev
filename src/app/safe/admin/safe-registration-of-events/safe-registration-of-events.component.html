<div class="row">
	<mdb-breadcrumb customClass="white" class="w-100">
		<mdb-breadcrumb-item class="">
			<mdb-icon fas icon="cog"></mdb-icon>
		</mdb-breadcrumb-item>
		<mdb-breadcrumb-item>PPA</mdb-breadcrumb-item>
		<mdb-breadcrumb-item>{{ "Bitacora de Eventos" | translate }}</mdb-breadcrumb-item>
		<mdb-breadcrumb-item>{{ "Listado de Eventos" | translate }}</mdb-breadcrumb-item>
		<mdb-breadcrumb-item class="active">{{ actionPage | translate }}</mdb-breadcrumb-item>
	</mdb-breadcrumb>
</div>

<form [formGroup]="formNewEvent" (ngSubmit)="onSubmitFormNewEvent()">
	<div class="section">
		<div class="row pb-2">
			<div class="col">
				<p class="section_titulo_0">{{ "Bitácora de Eventos" | translate }}</p>
				<p class="section_subtitulo_0"></p>
			</div>
		</div>
		<hr>
		<br>
		<div class="row pb-2">
			<div class="col">
				<p class="section_titulo_1">{{ "Descripción / Clasificacion de Evento" | translate }}</p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<app-mat-input-datepicker
					[formGroup]="formTemp"
					controlName="dateTimeStart" 
					(eventChange)="onChangeDateTimeStart()"
					label="Fecha Inicial"
				></app-mat-input-datepicker>
			</div>
			<div class="col">
				<app-mat-select 
					[formGroup]="formTemp"
					controlName="ha" 
					[options]="hours"
					(eventChange)="onChangeDateTimeStart()"
					[withEmptyOption]="false"
					label="Hora Inicial"
				></app-mat-select>
			</div>
			<div class="col">
				<app-mat-select 
					[formGroup]="formTemp"
					controlName="ma" 
					[options]="minutes"
					[withEmptyOption]="false"
					(eventChange)="onChangeDateTimeStart()"
					label="Minuto Inicial"
				></app-mat-select>
			</div>
			
			<div class="col">
				<app-mat-input-datepicker
					[formGroup]="formTemp"
					controlName="dateTimeEnd" 
					(eventChange)="onChangeDateTimeEnd()"
					label="Fecha Final"
				></app-mat-input-datepicker>
			</div>
			<div class="col">
				<app-mat-select
					[formGroup]="formTemp"
					controlName="hb" 
					[options]="hours"
					[withEmptyOption]="false"
					(eventChange)="onChangeDateTimeEnd()"
					label="Hora Final"
				></app-mat-select>
			</div>
			
			<div class="col">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formTemp"
					controlName="mb" 
					[options]="minutes"
					[withEmptyOption]="false"
					(eventChange)="onChangeDateTimeEnd()"
					label="Minuto Final"
				></app-mat-select>
			</div>

			<div class="col">
				<app-mat-select
					[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="eventsClassificationId"
					[options]="lstEventClassification"
					label="Clasificación de Eventos"
					(eventChange)="onBuildEventAssociated($event)"
				></app-mat-select>
			</div>
			<div class="col">
				<app-mat-select
					[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="eventsId"
					[options]="lstEvents"
					label="Eventos"
					(eventChange)="onBuildTemplate($event.value)"
				></app-mat-select>
			</div>

			<div class="w-100"></div>
			<div class="col">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="fuelsId"
					[options]="lstFuels"
					label="Combustible"
				></app-mat-select>
			</div>
			<div class="col">
				<app-mat-input-number
						[submitted]="submitted"
					[formGroup]="formNewEvent" 
					controlName="powerMw" 
					label="Potencia MW"
				></app-mat-input-number>
			</div>
			<div class="col">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="unitsId"
					[options]="lstUnits"
					label="Unidad"
				></app-mat-select>
			</div>
			<div class="col">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="impactContractsId"
					[options]="lstImpactContracts"
					label="Contrato Impactado"
				></app-mat-select>
			</div>
		</div>

		<div class="row pb-2">
			<div class="col">
				<p class="section_titulo_1">{{ "Contrato de Compraventa de Energía (PPA)" | translate }}</p>
			</div>
		</div>
		<div class="row">
			<div class="col-3">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="realsCcdvId"
					[options]="lstRealsCcdv"
					label="Real-CCDV"
				></app-mat-select>
			</div>
			<div class="col-3">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="toleranceBandsId"
					[options]="lstToleranceBands"
					label="Banda de Tolerancia"
				></app-mat-select>
			</div>
		</div>

		<div class="row pb-2">
			<div class="col">
				<p class="section_titulo_1">{{ "Mercado Eléctrico Mayorista (MEM)" | translate }}</p>
			</div>
		</div>
		<div class="row">
			<div class="col-3">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="marketTypesId"
					[options]="lstMarketTypes"
					label="Tipo de Mercado"
				></app-mat-select>
			</div>
			<div class="col-3">
				<app-mat-input-number
						[submitted]="submitted"
						[formGroup]="formNewEvent"
						controlName="mwOffered"
						label="MW Ofertados"
				></app-mat-input-number>
			</div>
			<div class="col-3">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="relatedServicesId"
					[options]="lstSelatedServices"
					label="Servicios Conexos"
				></app-mat-select>
			</div>
		</div>

		<div class="row pb-2">
			<div class="col">
				<p class="section_titulo_1">{{ "Licencia / Orden de Trabajo" | translate }}</p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<app-mat-input-text
						[submitted]="submitted"
					[formGroup]="formNewEvent" 
					controlName="licenseNumber" 
					label="# Licencia" 
				></app-mat-input-text>
			</div>
			<div class="col">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="equipmentId"
					[options]="lstEquipment"
					label="Equipo"
				></app-mat-select>
			</div>
			<div class="col">
				<app-mat-input-number
						[submitted]="submitted"
					[formGroup]="formNewEvent" 
					controlName="initialCharge" 
					label="Carga Inicial" 
				></app-mat-input-number>
			</div>
			<div class="col">
				<app-mat-input-number
						[submitted]="submitted"
					[formGroup]="formNewEvent" 
					controlName="finalCharge" 
					label="Carga Final" 
				></app-mat-input-number>
			</div>
			<div class="w-100"></div>
			<div class="col-3">
				<app-mat-input-number
						[submitted]="submitted"
					[formGroup]="formNewEvent" 
					controlName="mwPowerLoss" 
					label="(-) Perdida Potencia MW" 
				></app-mat-input-number>
			</div>
			<div class="col-3">
				<app-mat-input-textarea
						[submitted]="submitted"
						[formGroup]="formNewEvent"
						controlName="workOrderId"
						label="Orden de Trabajo"
						maxLength="500"
				></app-mat-input-textarea>
			</div>
			<div class="w-100"></div>
			<div class="col">
				<app-mat-input-textarea
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="licenseDescription"
					label="Descripción / Concepto de la Licencia"
					maxLength="2000"
				></app-mat-input-textarea>
			</div>
		</div>

		<div class="row pb-2">
			<div class="col">
				<p class="section_titulo_1">{{ "Fuente" | translate }}</p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<app-mat-input-text
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="plantOperatorOpened"
					label="Nombre(s)/Apellidos(s) Operador Planta Abrió"
				></app-mat-input-text>
			</div>
			<div class="col">
				<app-mat-input-text
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="cenaceOperatorOpened"
					label="Nombre(s)/Apellidos(s) Operador CENACE Abrió" 
				></app-mat-input-text>
			</div>
			<div class="w-100"></div>
			<div class="col">
				<app-mat-input-text
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="plantOperatorClosed"
					label="Nombre(s)/Apellidos(s) Operador Planta Cerro"
				></app-mat-input-text>
			</div>				
			<div class="col">
				<app-mat-input-text
						[submitted]="submitted"
					[formGroup]="formNewEvent" 
					controlName="cenaceOperatorClosed"
					label="Nombre(s)/Apellidos(s) Operador CENACE Cerro" 
				></app-mat-input-text>
			</div>
			<div class="w-100"></div>
			<div class="col-3">
				<app-mat-select
						[submitted]="submitted"
					[formGroup]="formNewEvent"
					controlName="sourceEventId"
					[options]="lstSourceEvent"
					label="Fuente del Evento"
				></app-mat-select>
			</div>
		</div>

		<div class="row pb-2">
			<div class="col">
				<p class="section_titulo_1">{{ "Estatus del Evento" | translate }}</p>
			</div>
		</div>
		<div class="row">
			<div class="col-3">
				<app-mat-input-text
						[submitted]="submitted"
						[formGroup]="formNewEvent"
						controlName="estatusEvento"
						label="Estatus del Evento"
				></app-mat-input-text>
			</div>
			<div class="col-3">
				<app-mat-input-text
						[submitted]="submitted"
						[formGroup]="formNewEvent"
						controlName="estatusAprobacion"
						label="Estatus de Aprobación"
				></app-mat-input-text>
			</div>
		</div>
	</div>
	<div class="section">
		
			<div class="row pb-2">
				<div class="col">
					<p class="section_titulo_1">{{ "Observaciones y/o comentarios" | translate }}</p>
				</div>
			</div>
			<div *ngIf="visibleObservation" class="row">
				<div class="col">
					<app-mat-input-textarea
						[formGroup]="formobservationsComments"
						controlName="observationsComments"
						maxLength="2000"
					></app-mat-input-textarea>
				</div>
			</div>
			<div *ngIf="visibleObservation" class="row justify-content-end">
				<div class="col-12 col-lg-2">
					<app-btn-block-add (click)="BtnAddObservationsComments()" [disabled]="actionPage === 'See'"></app-btn-block-add>
				</div>
			</div>
			<br>
			<div class="row">
				<div class="col">
					<app-mat-table 
						[data]="tableObservationsComments"
						[selection]="tableObservationsCommentsSelection"
						selectionLabel="Visible"
						[columnsDisplay]="tableColumnsDisplay"
						[columnsLabels]="tablaColumnsLabels"
						(clickEdit)="tableRowEdit($event)"
						(clickDelete)="tableRowDelete($event)"
					></app-mat-table>
				</div>
			</div>
		</div>
		<div class="section">

			<div class="row pb-2">
				<div class="col">
					<p class="section_titulo_1">{{ "Soportes" | translate }}</p>
				</div>
			</div>

			<div class="row">
				<div class="col">
					<div class="row">
						<div *ngFor="let file of files" class="media col-12 my-1" >
							<div class="row">
								<div class="col-auto  pr-0">
									<a *ngIf="!disabledSubmit" (click)="btnDeleteFile(file)">
										<img matTooltip="Eliminar archivo" src="assets/img/icon_delete.png" style="width: 20px;" />
									</a>
								</div>
								<div class="col pl-0" [ngSwitch]="file.bearerName.split('.')[1]">
									<img *ngSwitchCase="'png'" src="assets/img/jpg.png" style="width: 64px; height: 64px;" (click)="downloadFile(file)">
									<img *ngSwitchCase="'jpg'" src="assets/img/jpg.png" style="width: 64px; height: 64px;" (click)="downloadFile(file)">
									<img *ngSwitchCase="'zip'" src="assets/img/zip.png" style="width: 64px; height: 64px;" (click)="downloadFile(file)">
									<img *ngSwitchCase="'xls'" src="assets/img/xls.png" style="width: 64px; height: 64px;" (click)="downloadFile(file)">
									<img *ngSwitchCase="'xlsx'" src="assets/img/xls.png" style="width: 64px; height: 64px;" (click)="downloadFile(file)">
									<img *ngSwitchCase="'pdf'" src="assets/img/pdf.png" style="width: 64px; height: 64px;" (click)="downloadFile(file)">
									<div class="media-body">
										<p>Descarga {{file.bearerName}}</p>
									</div>
								</div>
							</div>
							
						</div>
					</div>
				</div>
				<div class="col" *ngIf="!disabledSubmit">
					<div class="row" [formGroup]="fileUploadForm">
						<div class="col">
							Carga Archivo:<br />
							<app-file-upload formControlName="file" [progress]="progress" [disabled]="actionPage === 'See'"></app-file-upload>
							<mat-error *ngIf="!fileUploadForm.controls['file'].valid && fileUploadForm.controls['file'].touched">
								Requerido
							</mat-error>
						</div>
						<div class="col-12 col-lg-3">
							<div class="row mt-2">
								<div class="col">
									<app-btn-block-import (click)="btnUploadFile()" [disabled]="!fileUploadForm.valid" ></app-btn-block-import>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>
		<div class="section">
			<div class="row">
				<div class="col">
					<!--div class="form-group">
						<label>Estado del elemento:</label><br>
						<mat-checkbox color="primary" formControlName="eventActivated">Activo</mat-checkbox>
					</div-->
				</div>
				<div class="col">
					<div class="row justify-content-end">
						<div class="col-12 col-lg-3">
							<app-btn-block-back (click)="btnClickBack()"></app-btn-block-back>
						</div>
						<div class="col-12 col-lg-6">
							<app-btn-block-save-update myType="submit" [disabled]="disabledSubmit"></app-btn-block-save-update>
						</div>
						<div class="col-12 col-lg-3" *ngIf="!disabledBtnFinish">
							<app-btn-block-finish (click)="btnFinish()" [disabled]="disabledBtnFinish"></app-btn-block-finish>
						</div>
					</div>
				</div>
			</div>
		</div>
	<div class="section" *ngIf="visibleAccepted">
		<div class="row">
			<div class="col">
				<div class="row justify-content-end">
					<div class="col-12 col-lg-6">
						<app-btn-block-acept label="Rechazar"  (click)="btnChangeStatus('Evento Rechazado')" [disabled]="disabledToRefuse"></app-btn-block-acept>
					</div>
					<div class="col-12 col-lg-6">
						<app-btn-block-acept label="Aceptar"  (click)="btnChangeStatus('Evento Aprobado')" [disabled]="disabledToAccept"></app-btn-block-acept>
					</div>
				</div>
			</div>
		</div>
	</div>
</form>
